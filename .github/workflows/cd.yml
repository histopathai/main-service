name: CD - Deploy Infrastructure

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'infrastructure/**'
      - '.github/workflows/cd.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
      image_tag:
        description: 'Docker image tag (optional, uses latest if not provided)'
        required: false
        type: string
      triggered_by:
        description: 'Triggered by (ci/manual)'
        required: false
        type: string
        default: 'manual'

env:
  TF_VERSION: '1.5.0'
  REPO_NAME: main-service
  
permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
      tfvars_file: ${{ steps.set-env.outputs.tfvars_file }}
    steps:
      - name: Determine Environment and Image
        id: set-env
        run: |
          # Determine environment
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
            IMAGE_TAG=""
          elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            ENV="dev"
            IMAGE_TAG=""
          else
            ENV="dev"
            IMAGE_TAG=""
          fi
          
          # Set tfvars file based on environment
          TFVARS_FILE="terraform.tfvars-${ENV}"
          
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "tfvars_file=${TFVARS_FILE}" >> $GITHUB_OUTPUT
          
          echo "ğŸŒ Environment: ${ENV}"
          echo "ğŸ³ Image Tag: ${IMAGE_TAG:-latest from environment}"
          echo "ğŸ“„ TF Vars File: ${TFVARS_FILE}"
          echo "ğŸ¯ Triggered by: ${{ inputs.triggered_by || 'infrastructure change' }}"

  terraform-validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          echo "ğŸ” Checking Terraform formatting..."
          if ! terraform fmt -check -recursive; then
            echo "âš ï¸  Warning: Some files are not formatted correctly"
            echo "Run 'terraform fmt -recursive' to fix formatting"
            exit 0
          fi
          echo "âœ… All files are properly formatted"

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Check TFVars File Exists
        run: |
          if [ ! -f "${{ needs.setup.outputs.tfvars_file }}" ]; then
            echo "âŒ ERROR: TFVars file not found: ${{ needs.setup.outputs.tfvars_file }}"
            echo "Available files:"
            ls -la terraform.tfvars* || echo "No terraform.tfvars files found"
            exit 1
          fi
          echo "âœ… TFVars file found: ${{ needs.setup.outputs.tfvars_file }}"

      - name: Validate TFVars Syntax
        run: |
          echo "ğŸ” Validating TFVars syntax..."
          terraform fmt -check "${{ needs.setup.outputs.tfvars_file }}" || true
          echo "âœ… TFVars syntax validated"

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [setup, terraform-validate]
    
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      ARTIFACT_REGISTRY_REPO_NAME: ${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}

    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GCP Project Info
        id: gcp-info
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          REGION="${{ env.GCP_REGION }}"
          
          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "region=${REGION}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Project ID: ${PROJECT_ID}"
          echo "ğŸŒ Region: ${REGION}"

      - name: Determine Image Tag
        id: image
        run: |
          if [ -n "${{ needs.setup.outputs.image_tag }}" ]; then
            IMAGE_TAG="${{ needs.setup.outputs.image_tag }}"
          else
            IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ env.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"
          fi
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ³ Using image: ${IMAGE_TAG}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}"

      - name: Terraform Plan
        id: plan
        run: |
          echo "ğŸ“Š Running Terraform plan..."
          terraform plan \
            -var-file="${{ needs.setup.outputs.tfvars_file }}" \
            -var="image_tag=${{ steps.image.outputs.image_tag }}" \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="tf_state_bucket=${{ env.TF_STATE_BUCKET }}" \
            -no-color \
            -out=tfplan
        continue-on-error: true

      - name: Save Plan Output
        if: success() || failure()
        run: terraform show -no-color tfplan > tfplan.txt

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ needs.setup.outputs.environment }}
          path: |
            infrastructure/tfplan
            infrastructure/tfplan.txt
          retention-days: 5

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [setup, terraform-validate, terraform-plan]
    if: github.event_name != 'pull_request'
    environment:
      name: ${{ needs.setup.outputs.environment }}

    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      ARTIFACT_REGISTRY_REPO_NAME: ${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}

    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GCP Project Info
        id: gcp-info
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          REGION="${{ env.GCP_REGION }}"
          
          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "region=${REGION}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Project ID: ${PROJECT_ID}"
          echo "ğŸŒ Region: ${REGION}"

      - name: Determine Image Tag
        id: image
        run: |
          if [ -n "${{ needs.setup.outputs.image_tag }}" ]; then
            IMAGE_TAG="${{ needs.setup.outputs.image_tag }}"
          else
            IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ env.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"
          fi
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ³ Using image: ${IMAGE_TAG}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}"

      - name: Terraform Apply
        run: |
          echo "ğŸš€ Applying Terraform changes for ${{ env.ENVIRONMENT }}..."
          terraform apply \
            -var-file="${{ needs.setup.outputs.tfvars_file }}" \
            -var="image_tag=${{ steps.image.outputs.image_tag }}" \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="tf_state_bucket=${{ env.TF_STATE_BUCKET }}" \
            -auto-approve

      - name: Terraform Output
        id: tf-output
        run: |
          echo "ğŸ“¤ Terraform Outputs:"
          terraform output -json > terraform-outputs.json
          cat terraform-outputs.json
          
          SERVICE_URL=$(terraform output -raw service_url 2>/dev/null || echo "N/A")
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo ""
          echo "âœ… Service URL: ${SERVICE_URL}"

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.setup.outputs.environment }}
          path: infrastructure/terraform-outputs.json
          retention-days: 30

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "================================"
          echo "ğŸŒ Environment: ${{ env.ENVIRONMENT }}"
          echo "ğŸ³ Image: ${{ steps.image.outputs.image_tag }}"
          echo "ğŸ”— Service URL: ${{ steps.tf-output.outputs.service_url }}"
          echo "ğŸ“¦ Triggered by: ${{ inputs.triggered_by || 'infrastructure change' }}"

    outputs:
      service_url: ${{ steps.tf-output.outputs.service_url }}

  notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [setup, terraform-apply]
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: Deployment Result
        run: |
          echo "ğŸ“Š CD Pipeline Summary"
          echo "====================="
          echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
          echo "ğŸ“¦ Triggered by: ${{ inputs.triggered_by || 'infrastructure change' }}"
          
          if [ "${{ needs.terraform-apply.result }}" == "success" ]; then
            echo ""
            echo "âœ… Deployment successful!"
            echo "ğŸ”— Service URL: ${{ needs.terraform-apply.outputs.service_url }}"
          else
            echo ""
            echo "âŒ Deployment failed!"
            exit 1
          fi